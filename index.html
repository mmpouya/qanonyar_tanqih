<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù„ÛŒÙ„ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ</title>
    <!-- Vazirmatn font import -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
        <!-- ğŸ”¹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† manifest.json Ø¨Ø±Ø§ÛŒ PWA -->
    <link rel="manifest" href="manifest.json">
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js")
                .then(() => console.log("âœ… Service Worker Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø³Ø§ÛŒØª Ø¢Ù…Ø§Ø¯Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø³Øª!"))
                .catch((error) => console.log("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Service Worker:", error));
        }
    </script>
        
        <!-- Ø³Ø§ÛŒØ± Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ùˆ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØª -->
    <link rel="stylesheet" href="styles.css">
    <style>
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
    </style>
</head>
<body>
    <!-- Overlay for file upload -->
    <div id="fileUploadOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,136,229,0.18);z-index:20000;display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;color:#1565c0;border-radius:14px;box-shadow:0 8px 32px rgba(30,136,229,0.18);padding:2.5rem 2.5rem;max-width:420px;width:90vw;text-align:center;">
            <h2 style="margin-bottom:1rem;">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ</h2>
            <p style="margin-bottom:2rem;">Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§ÛŒÙ„ JSON Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø§Ù…Ú©Ø§Ù†Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p>
            <label class="file-upload-label" style="margin-bottom:0;">
                <span>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ JSON</span>
                <input type="file" id="jsonFileOverlay" accept="application/json">
            </label>
        </div>
    </div>
    <!-- Dark mode toggle (top left, small) -->
    <button id="darkModeToggle" style="position:fixed;top:1rem;left:1rem;z-index:10001;display:flex;align-items:center;justify-content:center;width:36px;height:36px;padding:0;border-radius:50%;font-size:1.2rem;background:var(--primary-color);color:white;border:none;box-shadow:0 2px 6px rgba(30,136,229,0.10);">
        <span id="darkModeIcon">ğŸŒ™</span>
    </button>
    <div class="container disabled-ui" id="mainContainer">
        <!-- Step-by-step guide (compact) -->
        <button id="guideBtn" style="position:absolute; top:18px; right:32px; background:transparent; color:#1565c0; border:none; font-size:1.2rem; cursor:pointer; z-index:10; display:flex; align-items:center; gap:4px;">
            <span>Ø±Ø§Ù‡Ù†Ù…Ø§</span> <span style="font-size:1.3rem;">â„¹ï¸</span>
        </button>
        <!-- Guide Modal -->
        <div id="guideModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(30,136,229,0.12); z-index:9999; align-items:center; justify-content:center;">
            <div style="background:#fff; color:#1565c0; border-radius:14px; box-shadow:0 8px 32px rgba(30,136,229,0.18); padding:2rem 2.5rem; max-width:420px; width:90vw; position:relative;">
                <button id="closeGuideModal" style="position:absolute; top:12px; left:12px; background:transparent; border:none; font-size:1.3rem; color:#1565c0; cursor:pointer;">âœ–ï¸</button>
                <strong style="font-size:1.1rem;">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„:</strong>
                <ol style="margin:1rem 0 0 0; padding-right:1.2rem; color:#333; font-size:1.02rem;">
                    <li>Ø§Ø¨ØªØ¯Ø§ ÙØ§ÛŒÙ„ JSON Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.</li>
                    <li>Ø¨Ø®Ø´ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯.</li>
                    <li>Ù…Ø­ØªÙˆØ§ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</li>
                    <li>Ø¯Ø± Ù¾Ø§ÛŒØ§Ù†ØŒ ÙØ§ÛŒÙ„ ÙˆÛŒØ±Ø§ÛŒØ´â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ù…Ø§ÛŒÛŒØ¯.</li>
                </ol>
            </div>
        </div>
        <!-- File Upload Section -->
        <h3 style="color:var(--primary-color); margin-bottom:0.5rem;">Û±. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ</h3>
        <div class="file-upload">
            <label class="file-upload-label">
                <span>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ JSON</span>
                <input type="file" id="jsonFile" accept="application/json">
            </label>
        </div>
        <!-- Navigation Buttons (Top) -->
        <div id="navButtonsTop" class="nav-buttons beautiful-nav" style="justify-content:center; margin-bottom:0.5rem;">
            <button id="prevHadithBtn" class="button-nav beautiful-nav-btn">
                <span class="nav-icon">&#8592;</span>
                <span>Ù‚Ø¨Ù„ÛŒ</span>
            </button>
            <button id="nextHadithBtn" class="button-nav beautiful-nav-btn">
                <span>Ø¨Ø¹Ø¯ÛŒ</span>
                <span class="nav-icon">&#8594;</span>
            </button>
        </div>
        <!-- Hadith Selector Section -->
        <div id="hadithSelectorContainer" style="display:none; margin-bottom:1rem;align-items:center;gap:1rem;">
            <h3 style="color:var(--primary-color); margin-bottom:0.5rem;">Û². Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø®Ø´</h3>
            <label for="hadithSelector">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø®Ø´:</label>
            <select id="hadithSelector"></select>
            <span id="hadithCounter" class="hadith-counter" style="margin-right:1rem;"></span>
        </div>
        <!-- Filter Section -->
        <div id="filterSection" style="display:none; margin-bottom:1rem; padding:1rem; background:var(--bg-color); border-radius:8px;">
            <h3 style="color:var(--primary-color); margin-bottom:0.5rem;">ÙÛŒÙ„ØªØ±Ù‡Ø§</h3>
            <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:0.5rem;">
                <!-- Has Relationship Filter -->
                <div>
                    <label style="display:block; margin-bottom:0.3rem;">Ø¯Ø§Ø±Ø§ÛŒ Ø±Ø§Ø¨Ø·Ù‡:</label>
                    <div style="display:flex; gap:0.5rem;">
                        <label style="display:flex; align-items:center; gap:0.3rem;">
                            <input type="checkbox" id="filterHasRelationYes" value="true"> Ø¨Ù„Ù‡
                        </label>
                        <label style="display:flex; align-items:center; gap:0.3rem;">
                            <input type="checkbox" id="filterHasRelationNo" value="false"> Ø®ÛŒØ±
                        </label>
                    </div>
                </div>
                <!-- Qanon Filter -->
                <div>
                    <label style="display:block; margin-bottom:0.3rem;">Ù†Ø§Ù… Ù‚Ø§Ù†ÙˆÙ†:</label>
                    <select id="filterQanon" multiple style="min-width:200px; min-height:80px; padding:0.3rem;">
                        <option value="">Ù‡Ù…Ù‡</option>
                    </select>
                </div>
                <!-- Relation Type Filter -->
                <div>
                    <label style="display:block; margin-bottom:0.3rem;">Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡:</label>
                    <select id="filterRelationType" multiple style="min-width:200px; min-height:80px; padding:0.3rem;">
                        <option value="">Ù‡Ù…Ù‡</option>
                    </select>
                </div>
            </div>
            <div style="display:flex; gap:0.5rem;">
                <button id="applyFiltersBtn" class="button button-primary" style="min-width:100px;">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
                <button id="clearFiltersBtn" class="button button-secondary" style="min-width:100px;">Ø­Ø°Ù ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
            </div>
        </div>
        <!-- Filter Button (replaces filter section after filtering) -->
        <div id="filterButtonSection" style="display:none; margin-bottom:1rem; padding:1rem; background:var(--bg-color); border-radius:8px; text-align:center;">
            <button id="changeFiltersBtn" class="button button-primary" style="min-width:200px;">ØªØºÛŒÛŒØ± ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
        </div>
        <!-- Filter Modal -->
        <div id="filterModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(30,136,229,0.12); z-index:9999; align-items:center; justify-content:center;">
            <div style="background:#fff; color:#1565c0; border-radius:14px; box-shadow:0 8px 32px rgba(30,136,229,0.18); padding:2rem 2.5rem; max-width:600px; width:90vw; position:relative;">
                <h3 style="color:var(--primary-color); margin-bottom:1rem;">Ø§Ù†ØªØ®Ø§Ø¨ ÙÛŒÙ„ØªØ±Ù‡Ø§</h3>
                <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem;">
                    <!-- Has Relationship Filter -->
                    <div style="flex:1; min-width:200px;">
                        <label style="display:block; margin-bottom:0.3rem;">Ø¯Ø§Ø±Ø§ÛŒ Ø±Ø§Ø¨Ø·Ù‡:</label>
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                            <label style="display:flex; align-items:center; gap:0.3rem;">
                                <input type="checkbox" id="filterModalHasRelationYes" value="true"> Ø¨Ù„Ù‡
                            </label>
                            <label style="display:flex; align-items:center; gap:0.3rem;">
                                <input type="checkbox" id="filterModalHasRelationNo" value="false"> Ø®ÛŒØ±
                            </label>
                        </div>
                    </div>
                    <!-- Qanon Filter -->
                    <div style="flex:1; min-width:200px;">
                        <label style="display:block; margin-bottom:0.3rem;">Ù†Ø§Ù… Ù‚Ø§Ù†ÙˆÙ†:</label>
                        <select id="filterModalQanon" multiple style="width:100%; min-height:100px; padding:0.3rem;">
                        </select>
                    </div>
                    <!-- Relation Type Filter -->
                    <div style="flex:1; min-width:200px;">
                        <label style="display:block; margin-bottom:0.3rem;">Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡:</label>
                        <select id="filterModalRelationType" multiple style="width:100%; min-height:100px; padding:0.3rem;">
                        </select>
                    </div>
                </div>
                <div style="display:flex; justify-content:center; gap:1rem; margin-top:1rem;">
                    <button id="applyModalFiltersBtn" class="button button-primary" style="min-width:120px;">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
                    <button id="skipFiltersBtn" class="button button-secondary" style="min-width:120px;">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡</button>
                </div>
            </div>
        </div>
        <!-- Progress bar -->
        <div id="progressBarContainer" style="width:100%;height:8px;background:#e3f2fd;border-radius:4px;margin-bottom:1rem;display:none;">
            <div id="progressBar" style="height:100%;background:#1e88e5;width:0%;border-radius:4px;transition:width 0.3s;"></div>
        </div>
        <!-- Hadith Display Section -->
        <h3 style="color:var(--primary-color); margin-bottom:0.5rem;">Û³. Ù†Ù…Ø§ÛŒØ´ Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´</h3>
        <div id="hadithDisplay">
            <!-- Content will be dynamically inserted here -->
        </div>
        <!-- Floating Back to Top Button -->
        <button id="backToTopBtn" title="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¨Ø§Ù„Ø§" style="display:none; position:fixed; bottom:32px; left:32px; z-index:1000; background:#1e88e5; color:white; border:none; border-radius:50%; width:48px; height:48px; font-size:2rem; box-shadow:0 2px 8px rgba(0,0,0,0.2); cursor:pointer; transition:background 0.2s;">â†‘</button>
        <!-- Relation Type and Explanation Section -->
        <h3 style="color:var(--primary-color); margin-bottom:0.5rem; display:flex; align-items:center; gap:8px;">
            Û´. Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡ Ùˆ ØªÙˆØ¶ÛŒØ­
            <span title="Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡ Ø¨ÛŒÙ† Ø¯Ùˆ Ø¨Ø®Ø´ Ù‚Ø§Ù†ÙˆÙ†ÛŒ Ùˆ ØªÙˆØ¶ÛŒØ­ Ø¢Ù†" style="cursor:help; font-size:1.2rem; color:#00acc1;">â„¹ï¸</span>
        </h3>
        <div class="relation-info">
            <div id="relationTypeDisplay" style="margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-color); border-radius: 8px; display: flex; align-items: center;">
                <span id="relationTypeText"></span>
                <button id="editRelationTypeBtn" class="edit-button" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡">âœï¸</button>
            </div>
            <div id="relationExplanationDisplay" style="margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-color); border-radius: 8px; display: flex; align-items: center;">
                <span id="relationExplanationText"></span>
                <button id="editExplanationBtn" class="edit-button" title="ÙˆÛŒØ±Ø§ÛŒØ´ ØªÙˆØ¶ÛŒØ­">âœï¸</button>
            </div>
        </div>
        <!-- Save and Download Button -->
        <div style="margin-top: 1rem; text-align: center;">
            <button id="saveDownloadBtn" class="button button-primary" style="display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                <span>ğŸ’¾</span>
                <span>Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯</span>
            </button>
        </div>
        <!-- Navigation Buttons (Bottom) -->
        <div id="navButtonsBottom" class="nav-buttons beautiful-nav" style="justify-content:center; margin-top:0.5rem;">
            <button id="backBtnBottom" class="button button-secondary beautiful-nav-btn" style="min-width:100px;" onclick="navigateHadith(-1)">
                <span class="nav-icon">&#8592;</span>
                <span>Ù‚Ø¨Ù„ÛŒ</span>
            </button>
            <button id="nextBtnBottom" class="button button-secondary beautiful-nav-btn" style="min-width:100px;" onclick="navigateHadith(1)">
                <span>Ø¨Ø¹Ø¯ÛŒ</span>
                <span class="nav-icon">&#8594;</span>
            </button>
        </div>
    </div>
    <script>
        let sections = [];
        let selectedHadithIndex = 0;
        let uploadedFileName = "";
        // Filter variables
        let filteredSections = [];
        function showToast(title, message, type = 'success') {
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container';
                document.body.appendChild(toastContainer);
            }
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸' };
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }
        // Overlay logic and UI enable/disable
        function setUIEnabled(enabled) {
            const container = document.getElementById('mainContainer');
            if (enabled) {
                container.classList.remove('disabled-ui');
                Array.from(container.querySelectorAll('input, select, button')).forEach(el => {
                    if (!el.classList.contains('file-upload-label')) el.disabled = false;
                });
            } else {
                container.classList.add('disabled-ui');
                Array.from(container.querySelectorAll('input, select, button')).forEach(el => {
                    if (!el.classList.contains('file-upload-label')) el.disabled = true;
                });
            }
        }
        document.getElementById('jsonFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            uploadedFileName = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const raw = JSON.parse(e.target.result);
                    if (!Array.isArray(raw) || raw.length === 0) {
                        showToast('Ø®Ø·Ø§', 'Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„ JSON Ø¨Ø§ÛŒØ¯ Ø¢Ø±Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ Ø¨Ø§Ø´Ø¯.', 'error');
                        return;
                    }
                    sections = raw;
                    filteredSections = [...raw]; // Initialize filtered sections with all data
                    selectedHadithIndex = 0;
                    document.getElementById('fileUploadOverlay').style.display = 'none';
                    setUIEnabled(true);
                    populateHadithSelector();
                    populateFilterOptions(); // Populate filter options
                    populateModalFilterOptions(); // Populate modal filter options
                    document.getElementById('hadithSelectorContainer').style.display = 'flex';
                    document.getElementById('filterSection').style.display = 'block'; // Show filter section
                    document.getElementById('progressBarContainer').style.display = 'block';
                    // Show filter modal instead of directly showing data
                    document.getElementById('filterModal').style.display = 'flex';
                    // Hide main content until filters are applied
                    document.getElementById('hadithDisplay').style.display = 'none';
                    document.getElementById('relationTypeDisplay').style.display = 'none';
                    document.getElementById('relationExplanationDisplay').style.display = 'none';
                    document.getElementById('navButtonsTop').style.display = 'none';
                    document.getElementById('navButtonsBottom').style.display = 'none';
                    updateNavButtons();
                } catch (error) {
                    showToast('Ø®Ø·Ø§', 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ JSON. Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
                    return;
                }
            };
            reader.readAsText(file);
        });
        
        // Overlay file input
        document.getElementById('jsonFileOverlay').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            uploadedFileName = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const raw = JSON.parse(e.target.result);
                    if (!Array.isArray(raw) || raw.length === 0) {
                        showToast('Ø®Ø·Ø§', 'Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„ JSON Ø¨Ø§ÛŒØ¯ Ø¢Ø±Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ Ø¨Ø§Ø´Ø¯.', 'error');
                        return;
                    }
                    sections = raw;
                    filteredSections = [...raw]; // Initialize filtered sections with all data
                    selectedHadithIndex = 0;
                    document.getElementById('fileUploadOverlay').style.display = 'none';
                    setUIEnabled(true);
                    populateHadithSelector();
                    populateFilterOptions(); // Populate filter options
                    populateModalFilterOptions(); // Populate modal filter options
                    document.getElementById('hadithSelectorContainer').style.display = 'flex';
                    document.getElementById('filterSection').style.display = 'block'; // Show filter section
                    document.getElementById('progressBarContainer').style.display = 'block';
                    // Show filter modal instead of directly showing data
                    document.getElementById('filterModal').style.display = 'flex';
                    // Hide main content until filters are applied
                    document.getElementById('hadithDisplay').style.display = 'none';
                    document.getElementById('relationTypeDisplay').style.display = 'none';
                    document.getElementById('relationExplanationDisplay').style.display = 'none';
                    document.getElementById('navButtonsTop').style.display = 'none';
                    document.getElementById('navButtonsBottom').style.display = 'none';
                    updateNavButtons();
                } catch (error) {
                    showToast('Ø®Ø·Ø§', 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ JSON. Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
                    return;
                }
            };
            reader.readAsText(file);
        });
        // Filter functions
        function populateFilterOptions() {
            // Populate Qanon filter options
            const qanonSet = new Set();
            sections.forEach(section => {
                if (section.section_1_qanon) qanonSet.add(section.section_1_qanon);
                if (section.section_2_qanon) qanonSet.add(section.section_2_qanon);
            });
            
            const qanonFilter = document.getElementById('filterQanon');
            // Clear existing options except the first one
            while (qanonFilter.options.length > 1) {
                qanonFilter.remove(1);
            }
            // Add new options
            Array.from(qanonSet).sort().forEach(qanon => {
                const option = document.createElement('option');
                option.value = qanon;
                option.textContent = qanon;
                qanonFilter.appendChild(option);
            });
            
            // Populate Relation Type filter options
            const relationTypeSet = new Set();
            sections.forEach(section => {
                if (section.relation_type) relationTypeSet.add(section.relation_type);
            });
            
            const relationTypeFilter = document.getElementById('filterRelationType');
            // Clear existing options except the first one
            while (relationTypeFilter.options.length > 1) {
                relationTypeFilter.remove(1);
            }
            // Add new options
            Array.from(relationTypeSet).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                relationTypeFilter.appendChild(option);
            });
        }
        
        function populateModalFilterOptions() {
            // Populate Qanon filter options
            const qanonSet = new Set();
            sections.forEach(section => {
                if (section.section_1_qanon) qanonSet.add(section.section_1_qanon);
                if (section.section_2_qanon) qanonSet.add(section.section_2_qanon);
            });
            
            const qanonFilter = document.getElementById('filterModalQanon');
            // Clear existing options
            while (qanonFilter.options.length > 0) {
                qanonFilter.remove(0);
            }
            // Add new options
            Array.from(qanonSet).sort().forEach(qanon => {
                const option = document.createElement('option');
                option.value = qanon;
                option.textContent = qanon;
                qanonFilter.appendChild(option);
            });
            
            // Populate Relation Type filter options
            const relationTypeSet = new Set();
            sections.forEach(section => {
                if (section.relation_type) relationTypeSet.add(section.relation_type);
            });
            
            const relationTypeFilter = document.getElementById('filterModalRelationType');
            // Clear existing options
            while (relationTypeFilter.options.length > 0) {
                relationTypeFilter.remove(0);
            }
            // Add new options
            Array.from(relationTypeSet).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                relationTypeFilter.appendChild(option);
            });
        }
        
        function applyFilters() {
            // Get selected filter values
            const hasRelationYes = document.getElementById('filterHasRelationYes').checked;
            const hasRelationNo = document.getElementById('filterHasRelationNo').checked;
            
            const selectedQanons = Array.from(document.getElementById('filterQanon').selectedOptions)
                .map(option => option.value)
                .filter(value => value !== '');
                
            const selectedRelationTypes = Array.from(document.getElementById('filterRelationType').selectedOptions)
                .map(option => option.value)
                .filter(value => value !== '');
            
            // Apply filters
            filteredSections = sections.filter(section => {
                // Has relationship filter
                if (hasRelationYes || hasRelationNo) { // Removed hasRelationUnknown
                    const hasRelationValue = section.has_relationship;
                    let matches = false;
                    
                    if (hasRelationYes && hasRelationValue === true) matches = true;
                    if (hasRelationNo && hasRelationValue === false) matches = true;
                    // Removed check for hasRelationUnknown
                    
                    if (!matches) return false;
                }
                
                // Qanon filter
                if (selectedQanons.length > 0) {
                    const section1Qanon = section.section_1_qanon || '';
                    const section2Qanon = section.section_2_qanon || '';
                    let matches = false;
                    
                    selectedQanons.forEach(qanon => {
                        if (section1Qanon.includes(qanon) || section2Qanon.includes(qanon)) {
                            matches = true;
                        }
                    });
                    
                    if (!matches) return false;
                }
                
                // Relation type filter
                if (selectedRelationTypes.length > 0) {
                    const relationType = section.relation_type || '';
                    let matches = false;
                    
                    selectedRelationTypes.forEach(type => {
                        if (relationType.includes(type)) {
                            matches = true;
                        }
                    });
                    
                    if (!matches) return false;
                }
                
                return true;
            });
            
            // Update UI
            selectedHadithIndex = 0;
            populateHadithSelector();
            displayHadith();
            updateNavButtons();
            
            showToast('Ù…ÙˆÙÙ‚ÛŒØª', 'ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù†Ø¯.', 'success');
        }
        
        function clearFilters() {
            // Reset filter checkboxes
            document.getElementById('filterHasRelationYes').checked = false;
            document.getElementById('filterHasRelationNo').checked = false;
            
            // Reset filter selects
            document.getElementById('filterQanon').selectedIndex = -1;
            document.getElementById('filterRelationType').selectedIndex = -1;
            
            // Reset filtered sections to all data
            filteredSections = [...sections];
            
            // Update UI
            selectedHadithIndex = 0;
            populateHadithSelector();
            displayHadith();
            updateNavButtons();
            
            showToast('Ù…ÙˆÙÙ‚ÛŒØª', 'ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯.', 'success');
        }
        
        // Modal filter functions
        function applyModalFilters() {
            // Get selected filter values from modal
            const hasRelationYes = document.getElementById('filterModalHasRelationYes').checked;
            const hasRelationNo = document.getElementById('filterModalHasRelationNo').checked;
            
            const selectedQanons = Array.from(document.getElementById('filterModalQanon').selectedOptions)
                .map(option => option.value);
                
            const selectedRelationTypes = Array.from(document.getElementById('filterModalRelationType').selectedOptions)
                .map(option => option.value);
            
            // Apply filters
            filteredSections = sections.filter(section => {
                // Has relationship filter
                if (hasRelationYes || hasRelationNo) { // Removed hasRelationUnknown
                    const hasRelationValue = section.has_relationship;
                    let matches = false;
                    
                    if (hasRelationYes && hasRelationValue === true) matches = true;
                    if (hasRelationNo && hasRelationValue === false) matches = true;
                    // Removed check for hasRelationUnknown
                    
                    if (!matches) return false;
                }
                
                // Qanon filter
                if (selectedQanons.length > 0) {
                    const section1Qanon = section.section_1_qanon || '';
                    const section2Qanon = section.section_2_qanon || '';
                    let matches = false;
                    
                    selectedQanons.forEach(qanon => {
                        if (section1Qanon.includes(qanon) || section2Qanon.includes(qanon)) {
                            matches = true;
                        }
                    });
                    
                    if (!matches) return false;
                }
                
                // Relation type filter
                if (selectedRelationTypes.length > 0) {
                    const relationType = section.relation_type || '';
                    let matches = false;
                    
                    selectedRelationTypes.forEach(type => {
                        if (relationType.includes(type)) {
                            matches = true;
                        }
                    });
                    
                    if (!matches) return false;
                }
                
                return true;
            });
            
            // Update regular filter controls to match modal selections
            document.getElementById('filterHasRelationYes').checked = hasRelationYes;
            document.getElementById('filterHasRelationNo').checked = hasRelationNo;
            
            // Update Qanon filter selection
            const qanonSelect = document.getElementById('filterQanon');
            Array.from(qanonSelect.options).forEach(option => {
                option.selected = selectedQanons.includes(option.value);
            });
            
            // Update Relation Type filter selection
            const relationTypeSelect = document.getElementById('filterRelationType');
            Array.from(relationTypeSelect.options).forEach(option => {
                option.selected = selectedRelationTypes.includes(option.value);
            });
            
            // Hide modal and show data
            document.getElementById('filterModal').style.display = 'none';
            document.getElementById('hadithDisplay').style.display = 'block';
            document.getElementById('relationTypeDisplay').style.display = 'block';
            document.getElementById('relationExplanationDisplay').style.display = 'block';
            document.getElementById('navButtonsTop').style.display = 'flex';
            document.getElementById('navButtonsBottom').style.display = 'flex';
            
            // Hide filter section and show filter button
            document.getElementById('filterSection').style.display = 'none';
            document.getElementById('filterButtonSection').style.display = 'block';
            
            // Update UI
            selectedHadithIndex = 0;
            populateHadithSelector();
            displayHadith();
            updateNavButtons();
            
            showToast('Ù…ÙˆÙÙ‚ÛŒØª', 'ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù†Ø¯.', 'success');
        }
        
        function skipFilters() {
            // Hide modal and show all data
            document.getElementById('filterModal').style.display = 'none';
            document.getElementById('hadithDisplay').style.display = 'block';
            document.getElementById('relationTypeDisplay').style.display = 'block';
            document.getElementById('relationExplanationDisplay').style.display = 'block';
            document.getElementById('navButtonsTop').style.display = 'flex';
            document.getElementById('navButtonsBottom').style.display = 'flex';
            
            // Hide filter section and show filter button
            document.getElementById('filterSection').style.display = 'none';
            document.getElementById('filterButtonSection').style.display = 'block';
            
            // Reset filtered sections to all data
            filteredSections = [...sections];
            
            // Reset regular filter controls
            document.getElementById('filterHasRelationYes').checked = false;
            document.getElementById('filterHasRelationNo').checked = false;
            document.getElementById('filterQanon').selectedIndex = -1;
            document.getElementById('filterRelationType').selectedIndex = -1;
            
            // Update UI
            selectedHadithIndex = 0;
            populateHadithSelector();
            displayHadith();
            updateNavButtons();
        }
        
        function navigateHadith(direction) {
            if (!sections.length) return;
            let newIndex = selectedHadithIndex + direction;
            if (newIndex < 0) newIndex = 0;
            if (newIndex >= sections.length) newIndex = sections.length - 1;
            if (newIndex !== selectedHadithIndex) {
                selectedHadithIndex = newIndex;
                populateHadithSelector();
                displayHadith();
            }
            updateNavButtons();
        }
        function updateNavButtons() {
            const backBtnTop = document.getElementById('prevHadithBtn');
            const nextBtnTop = document.getElementById('nextHadithBtn');
            const backBtnBottom = document.getElementById('backBtnBottom');
            const nextBtnBottom = document.getElementById('nextBtnBottom');
            if (!sections.length) {
                [backBtnTop, nextBtnTop, backBtnBottom, nextBtnBottom].forEach(btn => { if (btn) btn.disabled = true; });
                return;
            }
            const atStart = selectedHadithIndex === 0;
            const atEnd = selectedHadithIndex === sections.length - 1;
            if (backBtnTop) backBtnTop.disabled = atStart;
            if (nextBtnTop) nextBtnTop.disabled = atEnd;
            if (backBtnBottom) backBtnBottom.disabled = atStart;
            if (nextBtnBottom) nextBtnBottom.disabled = atEnd;
        }
        // Modify populateHadithSelector to use filteredSections
        function populateHadithSelector() {
            const selector = document.getElementById('hadithSelector');
            selector.innerHTML = '';
            filteredSections.forEach((section, i) => {
                const option = document.createElement('option');
                option.value = i;
                // For new format, use section IDs
                const section1Id = section.section_1_id || `Ø¨Ø®Ø´ Û±`;
                const section2Id = section.section_2_id || `Ø¨Ø®Ø´ Û²`;
                const hasRelation = section.has_relationship === true ? ' (Ø¯Ø§Ø±Ø§ÛŒ Ø±Ø§Ø¨Ø·Ù‡)' : 
                                  section.has_relationship === false ? '' : 
                                  ' (Ø±Ø§Ø¨Ø·Ù‡ Ù†Ø§Ù…Ø´Ø®Øµ)';
                option.textContent = `Ù…Ù‚Ø§ÛŒØ³Ù‡ ${section1Id} Ùˆ ${section2Id}${hasRelation}`;
                selector.appendChild(option);
            });
            selector.value = selectedHadithIndex;
            selector.onchange = function() {
                selectedHadithIndex = parseInt(this.value, 10);
                displayHadith();
                updateNavButtons();
            };
            updateNavButtons();
        }
        // Modify getCurrentHadith to use filteredSections
        function getCurrentHadith() {
            return filteredSections[selectedHadithIndex] || null;
        }
        function displayHadith() {
            try {
                
                const section = getCurrentSectionWithEdits();
                console.log('Displaying section at index', selectedHadithIndex, ':', section);
                const hadithContainer = document.getElementById('hadithDisplay');
                hadithContainer.innerHTML = '';
                if (!section) {
                    hadithContainer.innerHTML = '<div style="color:#f44336;">Ù‡ÛŒÚ† Ø¨Ø®Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
                    return;
                }
                // Collapsible Section 1 Content
                const section1Div = document.createElement('div');
                section1Div.style.marginBottom = '0.5rem';
                const section1Header = document.createElement('button');
                section1Header.className = 'collapsible-header';
                section1Header.style = 'width:100%; text-align:right; background:#e3f2fd; color:#1565c0; border:none; border-radius:8px; padding:0.7rem 1rem; font-size:1.1rem; margin-bottom:0.2rem; cursor:pointer; display:flex; align-items:center; gap:8px;';
                const section1Qanon = section.section_1_qanon || '';
                const section1HeaderContent = section1Qanon ? 
                    `<span>Ù…ØªÙ† Ø¨Ø®Ø´ Ø§ÙˆÙ„ (${section1Qanon})</span><span class="arrow">â–²</span>` : 
                    '<span>Ù…ØªÙ† Ø¨Ø®Ø´ Ø§ÙˆÙ„</span><span class="arrow">â–²</span>';
                section1Header.innerHTML = section1HeaderContent;
                const section1Content = document.createElement('div');
                section1Content.className = 'collapsible-content';
                section1Content.style = 'padding:1rem; background:var(--bg-color); border-radius:8px; font-size:1.1rem; line-height:1.8; display:none;';
                // Convert \n to <br> for proper line breaks in HTML
                section1Content.innerHTML = (section.section_1_content || '(Ù…ØªÙ† Ø¨Ø®Ø´ Ø§ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª)').replace(/\n/g, '<br>');
                section1Div.appendChild(section1Header);
                section1Div.appendChild(section1Content);
                hadithContainer.appendChild(section1Div);
                // Collapsible Section 1 Rules
                const section1RulesDiv = document.createElement('div');
                section1RulesDiv.style.marginBottom = '0.5rem';
                const section1RulesHeader = document.createElement('button');
                section1RulesHeader.className = 'collapsible-header';
                section1RulesHeader.style = 'width:100%; text-align:right; background:#e3f2fd; color:#1e88e5; border:none; border-radius:8px; padding:0.7rem 1rem; font-size:1.1rem; margin-bottom:0.2rem; cursor:pointer; display:flex; align-items:center; gap:8px;';
                section1RulesHeader.innerHTML = '<span>Ø§Ø­Ú©Ø§Ù… Ø¨Ø®Ø´ Ø§ÙˆÙ„</span><span class="arrow">â–²</span>';
                const section1RulesContent = document.createElement('div');
                section1RulesContent.className = 'collapsible-content';
                section1RulesContent.style = 'padding:1rem; background:var(--bg-color); border-radius:8px; font-size:1.2rem; color:var(--primary-color); line-height:1.8; display:none;';
                // Convert \n to <br> for proper line breaks in HTML
                section1RulesContent.innerHTML = (section.section_1_rules || '').replace(/\n/g, '<br>');
                section1RulesDiv.appendChild(section1RulesHeader);
                section1RulesDiv.appendChild(section1RulesContent);
                hadithContainer.appendChild(section1RulesDiv);
                
                // Collapsible Section 2 Content
                const section2Div = document.createElement('div');
                section2Div.style.marginBottom = '0.5rem';
                const section2Header = document.createElement('button');
                section2Header.className = 'collapsible-header';
                section2Header.style = 'width:100%; text-align:right; background:#e3f2fd; color:#1565c0; border:none; border-radius:8px; padding:0.7rem 1rem; font-size:1.1rem; margin-bottom:0.2rem; cursor:pointer; display:flex; align-items:center; gap:8px;';
                const section2Qanon = section.section_2_qanon || '';
                const section2HeaderContent = section2Qanon ? 
                    `<span>Ù…ØªÙ† Ø¨Ø®Ø´ Ø¯ÙˆÙ… (${section2Qanon})</span><span class="arrow">â–²</span>` : 
                    '<span>Ù…ØªÙ† Ø¨Ø®Ø´ Ø¯ÙˆÙ…</span><span class="arrow">â–²</span>';
                section2Header.innerHTML = section2HeaderContent;
                const section2Content = document.createElement('div');
                section2Content.className = 'collapsible-content';
                section2Content.style = 'padding:1rem; background:var(--bg-color); border-radius:8px; font-size:1.1rem; line-height:1.8; display:none;';
                // Convert \n to <br> for proper line breaks in HTML
                section2Content.innerHTML = (section.section_2_content || '(Ù…ØªÙ† Ø¨Ø®Ø´ Ø¯ÙˆÙ… Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª)').replace(/\n/g, '<br>');
                section2Div.appendChild(section2Header);
                section2Div.appendChild(section2Content);
                hadithContainer.appendChild(section2Div);
                
                // Collapsible Section 2 Rules
                const section2RulesDiv = document.createElement('div');
                section2RulesDiv.style.marginBottom = '0.5rem';
                const section2RulesHeader = document.createElement('button');
                section2RulesHeader.className = 'collapsible-header';
                section2RulesHeader.style = 'width:100%; text-align:right; background:#e3f2fd; color:#1e88e5; border:none; border-radius:8px; padding:0.7rem 1rem; font-size:1.1rem; margin-bottom:0.2rem; cursor:pointer; display:flex; align-items:center; gap:8px;';
                section2RulesHeader.innerHTML = '<span>Ø§Ø­Ú©Ø§Ù… Ø¨Ø®Ø´ Ø¯ÙˆÙ…</span><span class="arrow">â–²</span>';
                const section2RulesContent = document.createElement('div');
                section2RulesContent.className = 'collapsible-content';
                section2RulesContent.style = 'padding:1rem; background:var(--bg-color); border-radius:8px; font-size:1.2rem; color:var(--primary-color); line-height:1.8; display:none;';
                // Convert \n to <br> for proper line breaks in HTML
                section2RulesContent.innerHTML = (section.section_2_rules || '').replace(/\n/g, '<br>');
                section2RulesDiv.appendChild(section2RulesHeader);
                section2RulesDiv.appendChild(section2RulesContent);
                hadithContainer.appendChild(section2RulesDiv);
                
                // Display has_relationship value prominently
                const hasRelationshipDiv = document.createElement('div');
                hasRelationshipDiv.style.marginBottom = '0.5rem';
                hasRelationshipDiv.style.padding = '1rem';
                hasRelationshipDiv.style.borderRadius = '8px';
                hasRelationshipDiv.style.fontSize = '1.1rem';
                hasRelationshipDiv.style.fontWeight = 'bold';
                hasRelationshipDiv.style.textAlign = 'center';
                
                if (section.has_relationship === true) {
                    hasRelationshipDiv.style.background = '#e8f5e9'; // Light green
                    hasRelationshipDiv.style.color = '#2e7d32'; // Dark green
                    hasRelationshipDiv.textContent = 'Ø¯Ø§Ø±Ø§ÛŒ Ø±Ø§Ø¨Ø·Ù‡: Ø¨Ù„Ù‡';
                } else if (section.has_relationship === false) {
                    hasRelationshipDiv.style.background = '#ffebee'; // Light red
                    hasRelationshipDiv.style.color = '#c62828'; // Dark red
                    hasRelationshipDiv.textContent = 'Ø¯Ø§Ø±Ø§ÛŒ Ø±Ø§Ø¨Ø·Ù‡: Ø®ÛŒØ±';
                } else {
                    hasRelationshipDiv.style.background = '#fff3e0'; // Light orange
                    hasRelationshipDiv.style.color = '#ef6c00'; // Dark orange
                    hasRelationshipDiv.textContent = 'Ø¯Ø§Ø±Ø§ÛŒ Ø±Ø§Ø¨Ø·Ù‡: Ù†Ø§Ù…Ø´Ø®Øµ';
                }
                
                hadithContainer.appendChild(hasRelationshipDiv);
                
                // Show relation_type and explanation in dedicated display areas
                const relationTypeText = document.getElementById('relationTypeText');
                const relationExplanationText = document.getElementById('relationExplanationText');
                
                if (relationTypeText) {
                    relationTypeText.textContent = section.relation_type ? `Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡: ${section.relation_type}` : 'Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡: -';
                }
                
                if (relationExplanationText) {
                    relationExplanationText.textContent = section.explanation ? `ØªÙˆØ¶ÛŒØ­: ${section.explanation}` : 'ØªÙˆØ¶ÛŒØ­: -';
                }
                
                // Collapsible Relationship Analysis
                const relationshipDiv = document.createElement('div');
                relationshipDiv.style.marginBottom = '0.5rem';
                const relationshipHeader = document.createElement('button');
                relationshipHeader.className = 'collapsible-header';
                relationshipHeader.style = 'width:100%; text-align:right; background:#f3e5f5; color:#7b1fa2; border:none; border-radius:8px; padding:0.7rem 1rem; font-size:1.1rem; margin-bottom:0.2rem; cursor:pointer; display:flex; align-items:center; gap:8px; direction:rtl;';
                relationshipHeader.innerHTML = '<span>ØªØ­Ù„ÛŒÙ„ Ø±Ø§Ø¨Ø·Ù‡</span><span class="arrow">â–²</span>';
                const relationshipContent = document.createElement('div');
                relationshipContent.className = 'collapsible-content';
                relationshipContent.style = 'padding:1rem; background:var(--bg-color); border-radius:8px; font-size:1.1rem; line-height:1.8; color:#333; direction:rtl; text-align:right; display:none;';
                
                // Create content for relationship analysis including relation_type and explanation
                let relationshipText = '';
                if (section.reason) {
                    relationshipText += `Ø¯Ù„ÛŒÙ„: ${section.reason}`;
                }
                if (!relationshipText) {
                    relationshipText = '(ØªØ­Ù„ÛŒÙ„ Ø±Ø§Ø¨Ø·Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª)';
                }
                
                // Convert \n to <br> for proper line breaks in HTML
                relationshipContent.innerHTML = relationshipText.replace(/\n/g, '<br>');
                relationshipDiv.appendChild(relationshipHeader);
                relationshipDiv.appendChild(relationshipContent);
                hadithContainer.appendChild(relationshipDiv);
                
                // Collapsible logic
                [section1Header, section1RulesHeader, section2Header, section2RulesHeader, relationshipHeader].forEach((header, idx) => {
                    header.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const arrow = this.querySelector('.arrow');
                        if (content.style.display === 'none') {
                            content.style.display = '';
                            arrow.textContent = 'â–¼';
                        } else {
                            content.style.display = 'none';
                            arrow.textContent = 'â–²';
                        }
                    });
                });
            } catch (err) {
                console.error('Error in displayHadith:', err);
                const hadithContainer = document.getElementById('hadithDisplay');
                hadithContainer.innerHTML = '<div style="color:#f44336;">Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.</div>';
            }
            updateNavButtons();
            // Update counter and progress bar
            const counter = document.getElementById('hadithCounter');
            if (counter && filteredSections.length) {
                counter.textContent = `Ø¨Ø®Ø´ ${selectedHadithIndex+1} Ø§Ø² ${filteredSections.length}`;
            }
            const progressBar = document.getElementById('progressBar');
            if (progressBar && filteredSections.length) {
                progressBar.style.width = `${((selectedHadithIndex+1)/filteredSections.length)*100}%`;
            }
        }
        // On load, show overlay and disable UI
        window.addEventListener('DOMContentLoaded', function() {
            setUIEnabled(false);
            document.getElementById('fileUploadOverlay').style.display = 'flex';
            // Fix: Add event listeners for top navigation buttons
            document.getElementById('prevHadithBtn').addEventListener('click', function() {
                navigateHadith(-1);
            });
            document.getElementById('nextHadithBtn').addEventListener('click', function() {
                navigateHadith(1);
            });
            
            // Add event listeners for filter buttons
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('changeFiltersBtn').addEventListener('click', function() {
                // Pre-populate modal with current filter values
                document.getElementById('filterModalHasRelationYes').checked = document.getElementById('filterHasRelationYes').checked;
                document.getElementById('filterModalHasRelationNo').checked = document.getElementById('filterHasRelationNo').checked;
                
                // Pre-select Qanon values
                const qanonSelect = document.getElementById('filterQanon');
                const modalQanonSelect = document.getElementById('filterModalQanon');
                Array.from(modalQanonSelect.options).forEach(option => {
                    option.selected = Array.from(qanonSelect.selectedOptions).some(selected => selected.value === option.value);
                });
                
                // Pre-select Relation Type values
                const relationTypeSelect = document.getElementById('filterRelationType');
                const modalRelationTypeSelect = document.getElementById('filterModalRelationType');
                Array.from(modalRelationTypeSelect.options).forEach(option => {
                    option.selected = Array.from(relationTypeSelect.selectedOptions).some(selected => selected.value === option.value);
                });
                
                // Show modal
                document.getElementById('filterModal').style.display = 'flex';
            });
            
            // Add event listeners for modal filter buttons
            document.getElementById('applyModalFiltersBtn').addEventListener('click', applyModalFilters);
            document.getElementById('skipFiltersBtn').addEventListener('click', skipFilters);
            
            // Add event listeners for edit buttons
            document.getElementById('editRelationTypeBtn').addEventListener('click', function() {
                startEditing('relation_type');
            });
            
            document.getElementById('editExplanationBtn').addEventListener('click', function() {
                startEditing('explanation');
            });
            
            // Add event listener for save and download button
            document.getElementById('saveDownloadBtn').addEventListener('click', downloadModifiedData);
        });
        document.getElementById('darkModeToggle').addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            document.getElementById('darkModeIcon').textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
        });
        window.onload = function() {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
            }
        }
        // Floating Back to Top Button logic
        const backToTopBtn = document.getElementById('backToTopBtn');
        window.addEventListener('scroll', function() {
            if (window.scrollY > 200) {
                backToTopBtn.style.display = 'block';
            } else {
                backToTopBtn.style.display = 'none';
            }
        });
        backToTopBtn.onclick = function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        // Guide Modal logic
        document.getElementById('guideBtn').onclick = function() {
            document.getElementById('guideModal').style.display = 'flex';
        };
        document.getElementById('closeGuideModal').onclick = function() {
            document.getElementById('guideModal').style.display = 'none';
        };
        document.getElementById('guideModal').addEventListener('click', function(e) {
            if (e.target === this) this.style.display = 'none';
        });
        
        // Add editing functionality
        let editedSections = {}; // To cache changes
        
        // Function to get current section with edits applied
        function getCurrentSectionWithEdits() {
            const section = getCurrentHadith();
            if (!section) return null;
            
            // Apply cached edits if they exist
            const sectionIndex = selectedHadithIndex;
            if (editedSections[sectionIndex]) {
                return { ...section, ...editedSections[sectionIndex] };
            }
            
            return section;
        }
        
        // Function to start editing a field
        function startEditing(field) {
            const section = getCurrentSectionWithEdits();
            if (!section) return;
            
            const displayElement = field === 'relation_type' ? 
                document.getElementById('relationTypeDisplay') : 
                document.getElementById('relationExplanationDisplay');
                
            const textElement = field === 'relation_type' ? 
                document.getElementById('relationTypeText') : 
                document.getElementById('relationExplanationText');
                
            const editButton = field === 'relation_type' ? 
                document.getElementById('editRelationTypeBtn') : 
                document.getElementById('editExplanationBtn');
            
            // Save current text
            const currentText = section[field] || '';
            
            // Create input field
            let input;
            if (field === 'explanation') {
                // Use textarea for explanation to handle multi-line text
                input = document.createElement('textarea');
                input.className = 'edit-input';
                input.value = currentText;
                input.style.flex = '1';
                input.style.width = '1000px';
                input.style.height = '250px';
                input.style.padding = '10px';
                input.style.fontFamily = 'inherit';
            } else {
                // Use regular input for relation_type
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'edit-input';
                input.value = currentText;
                input.style.flex = '1';
                input.style.width = '1000px';
            }
            
            // Create save button
            const saveButton = document.createElement('button');
            saveButton.className = 'save-edit';
            saveButton.innerHTML = 'âœ“';
            saveButton.title = 'Ø°Ø®ÛŒØ±Ù‡';
            
            // Create cancel button
            const cancelButton = document.createElement('button');
            cancelButton.className = 'cancel-edit';
            cancelButton.innerHTML = 'âœ•';
            cancelButton.title = 'Ù„ØºÙˆ';
            
            // Create actions container
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'edit-actions';
            actionsContainer.appendChild(saveButton);
            actionsContainer.appendChild(cancelButton);
            
            // Clear display element and add input and buttons
            displayElement.innerHTML = '';
            displayElement.appendChild(input);
            displayElement.appendChild(actionsContainer);
            
            // Focus input
            input.focus();
            
            // Save handler
            saveButton.addEventListener('click', function() {
                const newValue = input.value.trim();
                
                // Cache the edit
                const sectionIndex = selectedHadithIndex;
                if (!editedSections[sectionIndex]) {
                    editedSections[sectionIndex] = {};
                }
                editedSections[sectionIndex][field] = newValue || null;
                
                // Update display
                finishEditing(field, newValue);
                
                showToast('Ù…ÙˆÙÙ‚ÛŒØª', 'ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
            });
            
            // Cancel handler
            cancelButton.addEventListener('click', function() {
                finishEditing(field, currentText);
            });
            
            // Also save on Enter key (Ctrl+Enter for textarea)
            input.addEventListener('keydown', function(e) {
                if (field === 'explanation' && e.key === 'Enter' && e.ctrlKey) {
                    // For textarea, use Ctrl+Enter to save
                    saveButton.click();
                } else if (field !== 'explanation' && e.key === 'Enter') {
                    // For input, use Enter to save
                    saveButton.click();
                } else if (e.key === 'Escape') {
                    cancelButton.click();
                }
            });
        }
        
        // Function to finish editing and restore display
        function finishEditing(field, value) {
            const displayElement = field === 'relation_type' ? 
                document.getElementById('relationTypeDisplay') : 
                document.getElementById('relationExplanationDisplay');
                
            // Create new text element
            const newTextElement = document.createElement('span');
            newTextElement.id = field === 'relation_type' ? 'relationTypeText' : 'relationExplanationText';
            
            // Update text
            const displayText = value ? 
                (field === 'relation_type' ? `Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡: ${value}` : `ØªÙˆØ¶ÛŒØ­: ${value}`) : 
                (field === 'relation_type' ? 'Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡: -' : 'ØªÙˆØ¶ÛŒØ­: -');
                
            newTextElement.textContent = displayText;
            
            // Create new edit button
            const newEditButton = document.createElement('button');
            newEditButton.id = field === 'relation_type' ? 'editRelationTypeBtn' : 'editExplanationBtn';
            newEditButton.className = 'edit-button';
            newEditButton.title = field === 'relation_type' ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù†ÙˆØ¹ Ø±Ø§Ø¨Ø·Ù‡' : 'ÙˆÛŒØ±Ø§ÛŒØ´ ØªÙˆØ¶ÛŒØ­';
            newEditButton.innerHTML = 'âœï¸';
            
            // Add event listener to new edit button
            newEditButton.addEventListener('click', function() {
                startEditing(field);
            });
            
            // Clear display element and restore original structure
            displayElement.innerHTML = '';
            displayElement.appendChild(newTextElement);
            displayElement.appendChild(newEditButton);
        }
        
        // Function to download modified data
        function downloadModifiedData() {
            // Create a copy of the original data with edits applied
            const modifiedSections = sections.map((section, index) => {
                if (editedSections[index]) {
                    return { ...section, ...editedSections[index], is_edited: true };
                }
                return section;
            });
            
            // Create filename with current timestamp
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
            const fileName = uploadedFileName ? 
                `${uploadedFileName.replace('.json', '')}_${timestamp}.json` : 
                `modified_data_${timestamp}.json`;
            
            // Create and download file
            const dataStr = JSON.stringify(modifiedSections, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Ù…ÙˆÙÙ‚ÛŒØª', `ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯: ${fileName}`, 'success');
        }
        

    </script>
</body>
</html>
